<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Birthday Protocol</title>

  <style>
    :root{
      /* ====== Retro Navy UI (sharp edges) ====== */
      --bg0:#050817;
      --bg1:#071027;
      --bg2:#0b1a3b;

      --ink:#e9f0ff;
      --muted:#a8b7e6;

      --accentCyan:#4efcff;
      --accentPink:#ff3b7a;
      --accentGold:#ffd24a;

      --border: 2px solid rgba(78,252,255,.22);
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --shadowSoft: 0 10px 26px rgba(0,0,0,.40);

      --r: 10px;
      --r2: 6px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New";
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;

      /* ====== Paper Ticket Palette ====== */
      --paperA:#fff3cf;
      --paperB:#f3dfab;
      --paperInk:#1b1b22;
      --paperMuted:#534b3e;
      --paperEdge:#d3a64a;
      --paperShadow: 0 16px 42px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      font-family: var(--sans);
      color: var(--ink);
      overflow:hidden;
      position:relative;

      background:
        radial-gradient(900px 520px at 50% 15%, rgba(78,252,255,.14), transparent 60%),
        radial-gradient(850px 520px at 20% 80%, rgba(255,59,122,.12), transparent 62%),
        radial-gradient(820px 520px at 85% 75%, rgba(255,210,74,.10), transparent 64%),
        linear-gradient(145deg, var(--bg0), var(--bg1) 55%, var(--bg2));
    }

    /* subtle scanlines */
    body::before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      opacity:.10;
      background:
        repeating-linear-gradient(
          to bottom,
          rgba(255,255,255,.14) 0px,
          rgba(255,255,255,.14) 1px,
          transparent 2px,
          transparent 6px
        );
      mix-blend-mode: overlay;
    }

    /* subtle grid */
    body::after{
      content:"";
      position:fixed; inset:-20%;
      pointer-events:none;
      opacity:.10;
      background:
        linear-gradient(rgba(78,252,255,.18) 1px, transparent 1px) 0 0/60px 60px,
        linear-gradient(90deg, rgba(78,252,255,.12) 1px, transparent 1px) 0 0/60px 60px;
      transform: rotate(-6deg);
    }

    .wrap{ width:min(560px, 94vw); }

    /* ====== Main panels ====== */
    .card{
      background:
        radial-gradient(520px 300px at 18% 10%, rgba(78,252,255,.12), transparent 60%),
        radial-gradient(520px 300px at 82% 0%, rgba(255,59,122,.10), transparent 62%),
        linear-gradient(180deg, rgba(12,22,51,.94), rgba(10,19,44,.92));
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding: 22px 18px;
      text-align:center;
      border: var(--border);
      position:relative;
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute; left:0; right:0; top:0;
      height: 8px;
      background: linear-gradient(90deg, rgba(78,252,255,.95), rgba(255,59,122,.95), rgba(255,210,74,.95));
      opacity:.9;
    }
    .card > *{ position:relative; z-index:1; }

    h1{ margin: 10px 0 8px; font-size: 24px; letter-spacing:.2px; }
    p{ margin: 0 0 14px; opacity: .92; color: rgba(233,240,255,.92); }

    .warn{
      display:inline-flex; align-items:center; gap:10px;
      padding: 10px 12px;
      border-radius: var(--r2);
      background: rgba(255,210,74,.10);
      border: 2px solid rgba(255,210,74,.20);
      font-weight: 900;
      margin-bottom: 10px;
      box-shadow: var(--shadowSoft);
      color: rgba(233,240,255,.96);
    }

    .btns{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top: 10px; }
    button{
      border: 2px solid rgba(78,252,255,.18);
      border-radius: var(--r2);
      padding: 12px 14px;
      font-size: 16px;
      font-weight: 900;
      cursor:pointer;
      box-shadow: var(--shadowSoft);
      transition: transform .12s ease, filter .2s ease, opacity .2s ease;
      touch-action: manipulation;
      color: rgba(233,240,255,.95);
      background: rgba(0,0,0,.18);
    }
    button:active{ transform: scale(.985); }
    button:hover{ filter: brightness(1.05); }

    .primary{
      border: 0;
      background: linear-gradient(135deg, rgba(78,252,255,.95), rgba(255,59,122,.92));
      color: rgba(5,8,23,.95);
      box-shadow: 0 16px 30px rgba(0,0,0,.45);
    }
    .secondary{
      background: rgba(0,0,0,.18);
      border: 2px solid rgba(255,255,255,.10);
    }

    .tiny{
      font-size: 12px;
      opacity:.82;
      margin-top: 12px;
      color: rgba(168,183,230,.92);
    }

    /* ====== Inputs ====== */
    .card input{
      width: 100%;
      padding: 12px 14px;
      border-radius: var(--r2);
      border: 2px solid rgba(255,255,255,.10);
      background: rgba(5,8,23,.55);
      font-size: 15px;
      outline: none;
      margin-top: 10px;
      color: rgba(233,240,255,.96);
    }
    .card input::placeholder{ color: rgba(168,183,230,.78); }
    .card input:focus{
      border-color: rgba(78,252,255,.40);
      box-shadow: 0 0 0 4px rgba(78,252,255,.12);
    }
    .prominent{
      padding: 14px 14px !important;
      font-size: 16.5px !important;
      border: 2px solid rgba(255,210,74,.35) !important;
      background: rgba(5,8,23,.62) !important;
      box-shadow: 0 10px 22px rgba(0,0,0,.35);
    }

    .mutedLine{
      font-size: 12px;
      opacity:.90;
      margin-top: 10px;
      line-height: 1.45;
      color: rgba(168,183,230,.95);
    }
    .mutedLine b{ color: rgba(78,252,255,.92); }

    /* ====== Optional map ====== */
    .mapBox{ margin-top: 10px; text-align:left; }
    .mapRow{ display:flex; gap:10px; align-items:center; }
    .mapRow input{ margin-top: 0; flex: 1; }
    .mapFrame{
      width: 100%;
      height: 220px;
      border: 0;
      border-radius: var(--r);
      margin-top: 10px;
      background: rgba(0,0,0,.18);
      box-shadow: var(--shadowSoft);
    }

    details.mapDetails{
      text-align:left;
      margin-top: 12px;
      border-radius: var(--r);
      background: rgba(0,0,0,.16);
      border: 2px solid rgba(255,255,255,.08);
      padding: 10px 12px;
    }
    details.mapDetails summary{
      cursor:pointer;
      list-style:none;
      font-weight: 1000;
      user-select:none;
      opacity:.95;
      color: rgba(233,240,255,.92);
    }
    details.mapDetails summary::-webkit-details-marker{ display:none; }

    /* ====== Suggestions ====== */
    .suggestItem{
      width:100%;
      text-align:left;
      padding: 12px 12px;
      border-radius: var(--r2);
      background: rgba(0,0,0,.18);
      border: 2px solid rgba(255,255,255,.10);
      box-shadow: var(--shadowSoft);
      font-size: 14px;
      font-weight: 1000;
      cursor:pointer;
      color: rgba(233,240,255,.95);
    }
    .suggestItem span{
      display:block;
      margin-top: 4px;
      font-size: 12px;
      font-weight: 800;
      opacity: .80;
      color: rgba(168,183,230,.95);
    }

    /* ====== View switching ====== */
    .hidden{ display:none; }
    .fadeIn{ animation: fadeIn .28s ease both; }
    @keyframes fadeIn{ from{opacity:0; transform: translateY(10px)} to{opacity:1; transform: translateY(0)} }

    .wipe{
      position:fixed; inset:0;
      background: rgba(0,0,0,.25);
      backdrop-filter: blur(2px);
      animation: wipe .20s ease both;
      pointer-events:none;
    }
    @keyframes wipe{ from{opacity:0} to{opacity:1} }

    /* Confetti */
    #confettiCanvas{
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 9999;
    }

    /* ====== Heart quest ====== */
    .heartArena{
      position: relative;
      height: 240px;
      border-radius: var(--r);
      background:
        radial-gradient(520px 240px at 30% 10%, rgba(78,252,255,.12), transparent 60%),
        rgba(0,0,0,.14);
      overflow: hidden;
      border: 2px solid rgba(255,255,255,.08);
      margin-top: 12px;
      box-shadow: var(--shadowSoft);
    }
    .floatingHeart{
      position:absolute;
      font-size: 34px;
      user-select:none;
      cursor:pointer;
      filter: drop-shadow(0 10px 12px rgba(0,0,0,.30));
      animation: floatUp 3.2s linear forwards;
      will-change: transform, opacity;
    }
    @keyframes floatUp{
      0%{ transform: translateY(40px) scale(.95); opacity: 0; }
      10%{ opacity: 1; }
      100%{ transform: translateY(-280px) scale(1.05); opacity: 0; }
    }

    .choiceGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 12px;
    }
    .choiceGrid button{ width:100%; }

    /* ====== Vault options ====== */
    .vaultGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 12px;
    }
    @media (min-width: 520px){
      .vaultGrid{ grid-template-columns: 1fr 1fr 1fr; }
    }

    .vaultBtn{
      text-align:left;
      padding: 14px;
      border-radius: var(--r2);
      background: rgba(0,0,0,.16);
      border: 2px solid rgba(255,255,255,.10);
      box-shadow: var(--shadowSoft);
      font-weight: 1000;
      line-height: 1.1;
      color: rgba(233,240,255,.95);
      position:relative;
      overflow:hidden;
    }
    .vaultBtn span{
      display:block;
      margin-top: 6px;
      font-size: 13px;
      font-weight: 800;
      opacity: .86;
      color: rgba(168,183,230,.95);
      line-height:1.25;
    }

    /* decoy options feel intentionally ‚Äúnonsense‚Äù */
    .vaultBtn.decoy{
      border-color: rgba(255,255,255,.10);
      background:
        radial-gradient(340px 180px at 20% 0%, rgba(78,252,255,.06), transparent 60%),
        rgba(0,0,0,.16);
      opacity:.92;
    }

    /* featured rose option */
    .vaultBtn.featured{
      border-color: rgba(255,59,122,.55);
      background:
        radial-gradient(420px 220px at 18% 10%, rgba(255,59,122,.16), transparent 62%),
        radial-gradient(420px 220px at 82% 0%, rgba(78,252,255,.10), transparent 62%),
        rgba(0,0,0,.14);
      box-shadow: 0 16px 34px rgba(0,0,0,.55);
      transform: translateY(-1px);
    }
    .vaultBtn.featured::after{
      content:"";
      position:absolute; inset:-2px;
      border: 2px solid rgba(255,210,74,.22);
      pointer-events:none;
    }
    .vaultBtn .roseMark{
      display:inline-block;
      font-size: 18px;
      margin-right: 8px;
      transform: translateY(1px);
      filter: drop-shadow(0 10px 12px rgba(0,0,0,.30));
    }
    .vaultBtn.featured .roseHint{
      color: rgba(255,210,74,.95);
      font-weight: 1000;
    }

    .pill{
      display:inline-block;
      padding: 6px 10px;
      border-radius: var(--r2);
      background: rgba(0,0,0,.16);
      border: 2px solid rgba(255,255,255,.10);
      font-size: 12px;
      font-weight: 1000;
      margin: 6px 6px 0 0;
      color: rgba(233,240,255,.92);
    }

    .shake{ animation: shake .28s ease; }
    @keyframes shake{
      0%{ transform: translateX(0); }
      25%{ transform: translateX(-6px); }
      50%{ transform: translateX(6px); }
      75%{ transform: translateX(-4px); }
      100%{ transform: translateX(0); }
    }

    .miniHeart{
      position: fixed;
      left: 50%;
      top: 55%;
      font-size: 22px;
      pointer-events:none;
      filter: drop-shadow(0 10px 12px rgba(0,0,0,.30));
      animation: popHeart 900ms ease-out forwards;
      transform: translate(-50%,-50%);
      will-change: transform, opacity;
      z-index: 9999;
    }
    @keyframes popHeart{
      0%{ opacity:0; transform: translate(-50%,-50%) scale(.6); }
      20%{ opacity:1; }
      100%{ opacity:0; transform: translate(calc(-50% + var(--dx)), calc(-50% + var(--dy))) scale(1.1); }
    }

    /* ====== Intro ====== */
    .introSeal{
      width: 84px; height: 84px;
      margin: 0 auto 10px;
      border-radius: var(--r);
      background:
        radial-gradient(circle at 30% 30%, rgba(78,252,255,.20), rgba(0,0,0,.25));
      border: 2px solid rgba(78,252,255,.22);
      box-shadow: var(--shadowSoft);
      display:grid;
      place-items:center;
      position:relative;
      overflow:hidden;
    }
    .introSeal::after{
      content:"";
      position:absolute; inset:-40%;
      background:
        radial-gradient(circle at 40% 40%, rgba(255,59,122,.28), transparent 55%),
        radial-gradient(circle at 65% 55%, rgba(78,252,255,.22), transparent 55%);
      animation: swirl 3.2s ease-in-out infinite alternate;
      opacity:.9;
    }
    @keyframes swirl{
      from{ transform: translate(-6%, -4%) rotate(-6deg); }
      to{ transform: translate(6%, 4%) rotate(6deg); }
    }
    .introSeal span{
      position:relative; z-index:2;
      font-size: 30px;
      filter: drop-shadow(0 10px 12px rgba(0,0,0,.30));
    }

    .introLines{
      margin: 10px auto 0;
      text-align:left;
      max-width: 460px;
      font-weight: 900;
      line-height: 1.45;
      color: rgba(233,240,255,.92);
    }
    .introLine{
      opacity:0;
      transform: translateY(6px);
      animation: introIn .35s ease forwards;
      margin: 6px 0;
    }
    @keyframes introIn{
      to{ opacity:1; transform: translateY(0); }
    }
    .introLine b{ color: rgba(78,252,255,.92); }

    .introProgress{
      height: 10px;
      background: rgba(0,0,0,.22);
      border-radius: var(--r2);
      border: 2px solid rgba(255,255,255,.08);
      overflow:hidden;
      margin: 14px auto 0;
      max-width: 460px;
    }
    .introFill{
      height:100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(78,252,255,.95), rgba(255,59,122,.92));
      transition: width .25s ease;
    }

    /* =========================================================
       PAPER TICKET TEXTURE (APPLIED TO BOTH ticket + summary)
       ========================================================= */
    .ticketCard{
      text-align:left;
      border-radius: var(--r2);
      padding: 14px 14px 12px;
      position:relative;
      overflow:hidden;
      box-shadow: var(--paperShadow);
      border: 2px solid rgba(211,166,74,.80);
      color: var(--paperInk);

      background:
        repeating-linear-gradient(0deg, rgba(0,0,0,.020) 0px, rgba(0,0,0,.020) 1px, transparent 2px, transparent 6px),
        repeating-linear-gradient(90deg, rgba(0,0,0,.014) 0px, rgba(0,0,0,.014) 1px, transparent 2px, transparent 7px),
        radial-gradient(circle at 12% 18%, rgba(0,0,0,.055) 0 1px, transparent 2px),
        radial-gradient(circle at 28% 72%, rgba(0,0,0,.050) 0 1px, transparent 2px),
        radial-gradient(circle at 60% 40%, rgba(0,0,0,.050) 0 1px, transparent 2px),
        radial-gradient(circle at 84% 78%, rgba(0,0,0,.055) 0 1px, transparent 2px),
        radial-gradient(circle at 72% 18%, rgba(0,0,0,.045) 0 1px, transparent 2px),
        radial-gradient(540px 220px at 18% 0%, rgba(255,255,255,.60), transparent 60%),
        linear-gradient(180deg, var(--paperA), var(--paperB));
      background-size:
        auto, auto,
        220px 220px, 240px 240px, 260px 260px, 280px 280px, 300px 300px,
        auto, auto;
    }

    .ticketCard::before,
    .ticketCard::after{
      content:"";
      position:absolute;
      left:0; right:0;
      height: 14px;
      background:
        radial-gradient(circle at 9px 7px, transparent 0 6px, rgba(0,0,0,0) 7px) 0 0/18px 14px;
      pointer-events:none;
    }
    .ticketCard::before{ top:-7px; }
    .ticketCard::after{ bottom:-7px; }

    .ticketTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 10px;
      padding-top: 2px;
    }
    .ticketTitle{
      font-weight: 1100;
      letter-spacing: .45px;
      font-size: 13.5px;
      text-transform: uppercase;
      color: rgba(27,27,34,.92);
    }
    .ticketId{
      font-weight: 1100;
      font-family: var(--mono);
      font-size: 12.5px;
      background: rgba(0,0,0,.05);
      border: 2px solid rgba(0,0,0,.10);
      padding: 6px 10px;
      border-radius: var(--r2);
      white-space:nowrap;
      color: rgba(27,27,34,.92);
    }

    .ticketMeta{
      margin-top: 10px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      font-size: 13px;
      font-weight: 900;
    }
    .ticketMeta .cell{
      padding: 10px 10px;
      border-radius: var(--r2);
      background:
        radial-gradient(240px 120px at 20% 0%, rgba(255,255,255,.55), transparent 60%),
        rgba(255,255,255,.55);
      border: 2px solid rgba(0,0,0,.10);
      min-height: 44px;
    }
    .ticketMeta .k{
      display:block;
      font-size: 11px;
      opacity: .82;
      font-weight: 1000;
      margin-bottom: 4px;
      color: rgba(83,75,62,.90);
    }
    .ticketMeta .v{
      display:block;
      font-weight: 1100;
      overflow-wrap:anywhere;
      line-height: 1.25;
      color: rgba(27,27,34,.95);
    }

    .ticketCut{
      margin-top: 12px;
      border-top: 2px dashed rgba(0,0,0,.22);
      padding-top: 10px;
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:space-between;
    }
    .ticketNote{
      font-size: 12px;
      opacity:.90;
      font-weight: 900;
      line-height: 1.35;
      color: rgba(83,75,62,.92);
    }

    .ticketCard .pill{
      border-radius: var(--r2);
      background: rgba(0,0,0,.05);
      border: 2px solid rgba(0,0,0,.12);
      color: rgba(27,27,34,.90);
      font-weight: 1000;
    }

    .ticketActions{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .miniBtn{
      border: 2px solid rgba(0,0,0,.18);
      background: rgba(11,26,59,.94);
      padding: 10px 10px;
      border-radius: var(--r2);
      font-weight: 1000;
      font-size: 13px;
      box-shadow: 0 10px 22px rgba(0,0,0,.30);
      color: rgba(233,240,255,.95);
      text-decoration:none;
      display:inline-block;
    }
    .miniBtn.primaryMini{
      background: linear-gradient(135deg, rgba(78,252,255,.95), rgba(255,59,122,.92));
      color: rgba(5,8,23,.96);
      border: 0;
      box-shadow: 0 14px 26px rgba(0,0,0,.35);
    }
  </style>
</head>

<body>
  <canvas id="confettiCanvas" class="hidden"></canvas>

  <div class="wrap">
    <!-- INTRO -->
    <section id="screenIntro" class="card">
      <div class="warn">üìº Retro Transmission</div>
      <div class="introSeal"><span>‚òÖ</span></div>
      <h1>Birthday Protocol</h1>
      <p style="margin-bottom:10px;">Please hold. Calibrating vibes‚Ä¶</p>

      <div class="introLines" id="introLines"></div>
      <div class="introProgress" aria-label="loading">
        <div class="introFill" id="introFill"></div>
      </div>

      <div class="btns" style="margin-top:14px;">
        <button class="primary" id="btnIntroSkip">Continue</button>
      </div>
      <div class="tiny">Tip: you can tap Continue anytime.</div>
    </section>

    <!-- NOTICE -->
    <section id="screenNotice" class="card hidden">
      <div class="warn">üéüÔ∏è Alert</div>
      <h1>High-value human detected nearby.</h1>
      <p>Initiate Birthday Protocol with <b id="subjectName">Vrinda</b>?</p>
      <div class="btns">
        <button class="primary" id="btnBegin">Begin Protocol üéÇ</button>
        <button class="secondary" id="btnIgnore">Ignore (tempting fate)</button>
      </div>
      <div class="tiny">No personal data collected. Only vibes.</div>
    </section>

    <!-- HEARTS -->
    <section id="screenHearts" class="card hidden">
      <h1>Connection calibration</h1>
      <p>Collect <b>5 hearts</b> to stabilize the signal.</p>

      <div class="heartArena" id="heartArena" aria-label="heart game"></div>
      <div class="tiny" id="heartCounter">0 / 5 collected</div>
      <div class="tiny" style="opacity:.86;margin-top:6px;">Tip: tap the hearts before they float away üò≠</div>
    </section>

    <!-- SNACK -->
    <section id="screenSnack" class="card hidden">
      <div class="warn">üçø Snack Override</div>
      <h1>System stability at risk</h1>
      <p>Select the correct override snack to continue.</p>

      <div class="choiceGrid" id="snackChoices">
        <button class="secondary" data-snack="broccoli">ü•¶ broccoli</button>
        <button class="primary" data-snack="choki choki">üç´ choki choki</button>
        <button class="secondary" data-snack="engine oil">üõ¢Ô∏è engine oil</button>
        <button class="secondary" data-snack="wifi router">üì∂ wifi router</button>
      </div>
      <div class="tiny" id="snackHint" style="min-height:18px;"></div>
    </section>

    <!-- COORDS -->
    <section id="screenCoords" class="card hidden">
      <h1>Coordinates module: Bowling Rematch üé≥</h1>
      <p>
        Pick <b>any bowling alley</b> for our rematch.
        <b>Not today</b>‚Äîthis just bookmarks it.
      </p>

      <input id="venueInput" class="prominent" placeholder="Bowling place name ‚Äî e.g., 'Smaaash Koramangala'" />
      <input id="dateInput" type="date" class="prominent" />

      <div class="mutedLine">
        <b>Easy mode:</b> type the name + pick a date ‚Üí press <b>Save & Continue</b>.
        <br/>No copying links. We generate the Maps link automatically ‚úÖ
      </div>

      <div id="pickWrap" class="tiny" style="text-align:left;margin-top:10px;">
        <button class="secondary" id="btnSuggest" type="button">Show nearby options</button>
        <div id="suggestHint" class="tiny" style="min-height:18px;margin-top:8px;"></div>
        <div id="suggestList" style="display:grid;gap:8px;margin-top:8px;"></div>
      </div>

      <div class="btns" style="margin-top:10px;">
        <button class="secondary" id="btnUseLocation" type="button">Use my location</button>
        <button class="primary" id="btnVerifyMaps" type="button">Save & Continue</button>
        <button class="secondary" id="btnSkipMaps" type="button">Skip for now</button>
      </div>
      <div class="tiny" id="mapsHint" style="min-height:18px;"></div>

      <details class="mapDetails" id="mapDetails">
        <summary>Map (optional)</summary>

        <div class="mapBox">
          <div class="mapRow" style="margin-top:10px;">
            <input id="cityInput" placeholder="City (optional) ‚Äî e.g., Bengaluru / Mumbai" />
            <button class="secondary" id="btnOpenMap" type="button">Open Maps</button>
          </div>

          <iframe
            id="mapFrame"
            class="mapFrame"
            loading="lazy"
            referrerpolicy="no-referrer-when-downgrade"
            src="https://www.google.com/maps?q=bowling%20alley%20near%20me&output=embed"></iframe>

          <div class="mutedLine">This map is just a helper. You don‚Äôt need to copy anything from it.</div>
        </div>
      </details>
    </section>

    <!-- VAULT -->
    <section id="screenVault" class="card hidden">
      <h1>Gift Vault</h1>
      <p>Pick an option. (Two are decoys. One smells like <b>roses</b>.)</p>

      <div class="vaultGrid">
        <!-- Keep data-path the same (plan/treat/token) to preserve all logic -->
        <button class="vaultBtn decoy" data-path="plan">üçø Popcorn Time-Machine
          <span>Redeems: cinematic vibes + minor confusion.<br/>Not valid in this timeline.</span>
        </button>

        <button class="vaultBtn decoy" data-path="treat">üì∂ Wi-Fi Blessing Ritual
          <span>Redeems: stronger signal + emotional buffering.<br/>Results may be imaginary.</span>
        </button>

        <button class="vaultBtn featured" data-path="token"><span class="roseMark">üåπ</span>Rose Vault
          <span><span class="roseHint">This one is real.</span> Hidden gift logic inside.<br/>Choose me if you like roses.</span>
        </button>
      </div>

      <div class="tiny" id="vaultHint" style="min-height:18px;margin-top:10px;"></div>
    </section>

    <!-- MODE -->
    <section id="screenMode" class="card hidden">
      <h1>Artifact mode selection</h1>
      <p>This changes the <b>aesthetic</b> of the claim output. Choose one.</p>
      <div class="btns">
        <button class="secondary" data-mode="Classic">Classic</button>
        <button class="primary" data-mode="Soft">Soft</button>
        <button class="secondary" data-mode="Chaos">Chaos</button>
      </div>
      <div class="tiny" id="modeHint" style="min-height:18px;margin-top:10px;"></div>
    </section>

    <!-- TICKET -->
    <section id="screenTicket" class="card hidden">
      <h1>Claim ticket generated ‚úÖ</h1>
      <p><b>Screenshot this</b> and keep it safe. Redemption requires in-person verification.</p>

      <div id="ticketBox"></div>

      <div class="btns" style="margin-top:10px;">
        <button class="secondary" id="btnCopyTicket">Copy Ticket</button>
        <button class="secondary" id="btnDownloadTicket">Download Ticket</button>
        <button class="primary" id="btnFinish">Finish</button>
      </div>
      <div class="tiny" id="ticketHint" style="min-height:18px;margin-top:10px;"></div>
    </section>

    <!-- SUCCESS -->
    <section id="screenSuccess" class="card hidden">
      <h1>Protocol complete üíó</h1>
      <p>Ticket is ready. Claim it later <b>(after dinner)</b> with <b id="operatorName2">Avneesh</b>.</p>
      <div class="btns" style="margin-top:12px;">
        <button class="primary" id="btnViewSummary" type="button">View Mission Summary üì∏</button>
      </div>
      <div class="tiny">Status: birthday energy stabilized ‚úÖ</div>
    </section>

    <!-- SUMMARY -->
    <section id="screenSummary" class="card hidden">
      <h1>Mission Summary</h1>
      <p>Take a <b>screenshot of this page</b> and send it to <b id="operatorName3">Avneesh</b> üì∏</p>

      <div id="summaryBox"></div>

      <div class="btns" style="margin-top:10px;">
        <button class="secondary" id="btnCopySummary" type="button">Copy Summary</button>
        <button class="primary" id="btnShareSummary" type="button">Share Summary</button>
      </div>
      <div class="tiny" id="summaryHint" style="min-height:18px;margin-top:10px;"></div>
    </section>
  </div>

  <script>
    // ====== Editable names ======
    const GIRL_NAME = "Vrinda";
    const YOUR_NAME = "Avneesh";

    // ====== State ======
    let protocolStartedAt = null;
    let protocolCompletedAt = null;

    let snackSelected = "";
    let ticketId = null;
    let summaryText = "";
    let chosenPath = "";
    let chosenMode = "Soft";
    let ticketText = "";

    // ====== Helpers ======
    function escapeHtml(s){
      return (s || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;");
    }
    function showWipe(){
      const w = document.createElement("div");
      w.className = "wipe";
      document.body.appendChild(w);
      setTimeout(()=> w.remove(), 220);
    }
    function show(el){
      el.classList.remove("hidden");
      el.classList.add("fadeIn");
    }
    function hide(el){ el.classList.add("hidden"); }

    function randInt(min, max){ return Math.floor(Math.random() * (max - min + 1)) + min; }
    function randFloat(min, max){ return Math.random() * (max - min) + min; }
    function clamp01(x){ return Math.max(0, Math.min(1, x)); }

    function fmtDateISO(iso){
      if(!iso) return "";
      const d = new Date(iso + "T00:00:00");
      if(Number.isNaN(d.getTime())) return "";
      return d.toLocaleDateString(undefined, { year:"numeric", month:"short", day:"2-digit" });
    }

    function applyNames(){
      const subjEl = document.getElementById("subjectName");
      const op2 = document.getElementById("operatorName2");
      const op3 = document.getElementById("operatorName3");
      if (subjEl) subjEl.textContent = GIRL_NAME;
      if (op2) op2.textContent = YOUR_NAME;
      if (op3) op3.textContent = YOUR_NAME;
    }

    function getPathLabel(path){
      // UI labels only (logic keys remain plan/treat/token)
      if(path === "plan") return "Popcorn Time-Machine";
      if(path === "treat") return "Wi-Fi Blessing Ritual";
      if(path === "token") return "Rose Vault üåπ";
      return path || "";
    }

    // ---- Download ticket as IMAGE (PNG) ----
    async function downloadTicketAsPng(){
      const el = document.querySelector("#ticketBox .ticketCard");
      if(!el){
        const hint = document.getElementById("ticketHint");
        if(hint) hint.textContent = "Ticket not ready yet.";
        return;
      }

      const rect = el.getBoundingClientRect();
      const w = Math.max(1, Math.ceil(rect.width));
      const h = Math.max(1, Math.ceil(rect.height));

      const styleText = document.querySelector("style")?.innerHTML || "";

      // Hide action buttons in the exported image (keep ticket only)
      const exportCss = `
        .ticketActions{ display:none !important; }
        #btnCopyTicketMini, #btnDownloadTicketMini { display:none !important; }
      `;

      // Build SVG with foreignObject (Chrome/Edge friendly)
      const svg =
`<svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}">
  <foreignObject x="0" y="0" width="100%" height="100%">
    <div xmlns="http://www.w3.org/1999/xhtml" style="width:${w}px;height:${h}px;">
      <style>${styleText}\n${exportCss}</style>
      ${el.outerHTML}
    </div>
  </foreignObject>
</svg>`;

      const svgBlob = new Blob([svg], { type: "image/svg+xml;charset=utf-8" });
      const svgUrl = URL.createObjectURL(svgBlob);

      const img = new Image();
      img.decoding = "async";

      img.onload = () => {
        const scale = Math.max(1, Math.min(2, window.devicePixelRatio || 1)); // crisp but not huge
        const canvas = document.createElement("canvas");
        canvas.width = Math.round(w * scale);
        canvas.height = Math.round(h * scale);
        const ctx = canvas.getContext("2d");

        ctx.setTransform(scale, 0, 0, scale, 0, 0);
        ctx.imageSmoothingEnabled = true;

        // White-ish background so paper looks real even on transparent viewers
        ctx.fillStyle = "#0b1a3b";
        ctx.fillRect(0, 0, w, h);

        ctx.drawImage(img, 0, 0, w, h);

        canvas.toBlob((pngBlob) => {
          URL.revokeObjectURL(svgUrl);
          if(!pngBlob){
            const hint = document.getElementById("ticketHint");
            if(hint) hint.textContent = "Couldn‚Äôt export image. Screenshot works.";
            return;
          }
          const url = URL.createObjectURL(pngBlob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `birthday_ticket_${ticketId || "0000"}.png`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          setTimeout(() => URL.revokeObjectURL(url), 800);

          const hint = document.getElementById("ticketHint");
          if(hint) hint.textContent = "Downloaded PNG ‚úÖ";
        }, "image/png");
      };

      img.onerror = () => {
        URL.revokeObjectURL(svgUrl);
        const hint = document.getElementById("ticketHint");
        if(hint) hint.textContent = "Image export blocked in this browser. Screenshot works.";
      };

      img.src = svgUrl;
    }

    // ====== Screen refs ======
    const screenIntro   = document.getElementById("screenIntro");
    const screenNotice  = document.getElementById("screenNotice");
    const screenHearts  = document.getElementById("screenHearts");
    const screenSnack   = document.getElementById("screenSnack");
    const screenCoords  = document.getElementById("screenCoords");
    const screenVault   = document.getElementById("screenVault");
    const screenMode    = document.getElementById("screenMode");
    const screenTicket  = document.getElementById("screenTicket");
    const screenSuccess = document.getElementById("screenSuccess");
    const screenSummary = document.getElementById("screenSummary");

    // ====== Intro ======
    const introLinesEl = document.getElementById("introLines");
    const introFillEl  = document.getElementById("introFill");
    const btnIntroSkip = document.getElementById("btnIntroSkip");

    const introScript = [
      `Signal acquired.`,
      `Target: <b>${escapeHtml(GIRL_NAME)}</b>.`,
      `Mission: smiles (repeatable).`,
      `Loading quests + final ticket‚Ä¶`
    ];

    async function runIntro(){
      if(!introLinesEl) return;
      introLinesEl.innerHTML = "";
      introFillEl.style.width = "0%";

      for(let i=0; i<introScript.length; i++){
        const div = document.createElement("div");
        div.className = "introLine";
        div.innerHTML = introScript[i];
        introLinesEl.appendChild(div);

        const pct = Math.round(((i+1)/introScript.length) * 100);
        introFillEl.style.width = pct + "%";
        await new Promise(r => setTimeout(r, 520));
      }
      btnIntroSkip.textContent = "Continue";
    }

    function goToNotice(){
      if(screenIntro.classList.contains("hidden")) return;
      showWipe();
      hide(screenIntro);
      show(screenNotice);
    }
    btnIntroSkip?.addEventListener("click", goToNotice);

    // ====== Notice ======
    const btnBegin  = document.getElementById("btnBegin");
    const btnIgnore = document.getElementById("btnIgnore");

    btnIgnore?.addEventListener("click", () => {
      btnIgnore.textContent = "Ignore (system judging...)";
      btnIgnore.disabled = true;
      setTimeout(() => {
        btnIgnore.disabled = false;
        btnIgnore.textContent = "Ignore (tempting fate)";
      }, 900);
    });

    btnBegin?.addEventListener("click", () => {
      protocolStartedAt = new Date();
      showWipe();
      hide(screenNotice);
      show(screenHearts);
      startHeartGame();
    });

    // ====== Quest 1: Hearts ======
    const heartArena = document.getElementById("heartArena");
    const heartCounter = document.getElementById("heartCounter");
    let heartsCollected = 0;
    let heartSpawner = null;

    function burstHearts(count=12){
      for(let i=0; i<count; i++){
        const h = document.createElement("div");
        h.className = "miniHeart";
        h.textContent = Math.random() < 0.2 ? "üíò" : "üíó";
        const dx = (Math.random() * 220 - 110).toFixed(0) + "px";
        const dy = (Math.random() * -220 - 40).toFixed(0) + "px";
        h.style.setProperty("--dx", dx);
        h.style.setProperty("--dy", dy);
        document.body.appendChild(h);
        setTimeout(()=> h.remove(), 950);
      }
    }

    function spawnHeart(){
      if(!heartArena) return;
      const h = document.createElement("div");
      h.className = "floatingHeart";
      h.textContent = Math.random() < 0.2 ? "üíò" : "üíó";
      const arenaW = heartArena.clientWidth || 300;
      const x = randInt(10, Math.max(10, arenaW - 44));
      h.style.left = x + "px";
      h.style.bottom = "-10px";
      h.style.animationDuration = (Math.random() * 0.9 + 2.7).toFixed(2) + "s";

      h.addEventListener("click", () => {
        h.remove();
        heartsCollected++;
        if(heartCounter) heartCounter.textContent = `${heartsCollected} / 5 collected`;

        if(heartsCollected >= 5){
          clearInterval(heartSpawner);
          heartSpawner = null;
          burstHearts(16);
          setTimeout(() => {
            showWipe();
            hide(screenHearts);
            show(screenSnack);
          }, 500);
        }
      });

      heartArena.appendChild(h);
      setTimeout(() => { if (h.isConnected) h.remove(); }, 3800);
    }

    function startHeartGame(){
      heartsCollected = 0;
      if(heartCounter) heartCounter.textContent = "0 / 5 collected";
      if(heartArena) heartArena.innerHTML = "";
      spawnHeart(); spawnHeart();
      heartSpawner = setInterval(() => spawnHeart(), 520);
    }

    // ====== Quest 2: Snack ======
    const snackChoices = document.getElementById("snackChoices");
    const snackHint = document.getElementById("snackHint");

    snackChoices?.addEventListener("click", (e) => {
      const btn = e.target.closest("button");
      if(!btn) return;
      const pick = (btn.getAttribute("data-snack") || "").toLowerCase();

      if(pick === "choki choki"){
        snackSelected = pick;
        if(snackHint) snackHint.textContent = "Override accepted ‚úÖ Sweetness levels normalized.";
        burstHearts(10);
        setTimeout(() => {
          showWipe();
          hide(screenSnack);
          prepCoords();
          show(screenCoords);
          if(snackHint) snackHint.textContent = "";
        }, 650);
      } else {
        if(snackHint) snackHint.textContent = "Override rejected ‚ùå That is not a snack (be serious).";
        btn.classList.add("shake");
        setTimeout(()=> btn.classList.remove("shake"), 320);
      }
    });

    // ====== Quest 3: Coordinates ======
    const LS_BOWLING_LINK  = "bp_bowling_link";
    const LS_BOWLING_VENUE = "bp_bowling_venue";
    const LS_BOWLING_DATE  = "bp_bowling_date";
    const LS_BOWLING_SAVED = "bp_bowling_saved_at";

    const venueInput = document.getElementById("venueInput");
    const dateInput  = document.getElementById("dateInput");

    const btnUseLocation = document.getElementById("btnUseLocation");
    const btnVerifyMaps  = document.getElementById("btnVerifyMaps");
    const btnSkipMaps    = document.getElementById("btnSkipMaps");
    const mapsHint       = document.getElementById("mapsHint");

    const cityInput  = document.getElementById("cityInput");
    const btnOpenMap = document.getElementById("btnOpenMap");
    const mapFrame   = document.getElementById("mapFrame");

    const btnSuggest  = document.getElementById("btnSuggest");
    const suggestList = document.getElementById("suggestList");
    const suggestHint = document.getElementById("suggestHint");

    let bowlingLink  = "";
    let bowlingVenue = "";
    let bowlingDate  = "";

    let userLat = null;
    let userLng = null;

    function rememberUserLocation(lat, lng){
      userLat = lat;
      userLng = lng;
    }

    function getBowlingQuery(){
      const city = (cityInput?.value || "").trim();
      return city ? `bowling alley in ${city}` : "bowling alley near me";
    }

    function refreshEmbeddedMap(){
      if(!mapFrame) return;
      const q = getBowlingQuery();
      mapFrame.src = `https://www.google.com/maps?q=${encodeURIComponent(q)}&output=embed`;
    }

    function openMapSearch(){
      const q = getBowlingQuery();
      window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`, "_blank", "noopener");
    }

    function saveBowlingBookmark(){
      try{
        localStorage.setItem(LS_BOWLING_LINK, bowlingLink || "");
        localStorage.setItem(LS_BOWLING_VENUE, bowlingVenue || "");
        localStorage.setItem(LS_BOWLING_DATE, bowlingDate || "");
        localStorage.setItem(LS_BOWLING_SAVED, new Date().toISOString());
      }catch(_){}
    }

    function loadBowlingBookmark(){
      try{
        bowlingLink  = localStorage.getItem(LS_BOWLING_LINK)  || "";
        bowlingVenue = localStorage.getItem(LS_BOWLING_VENUE) || "";
        bowlingDate  = localStorage.getItem(LS_BOWLING_DATE)  || "";
      }catch(_){
        bowlingLink = ""; bowlingVenue = ""; bowlingDate = "";
      }
      if(venueInput) venueInput.value = bowlingVenue || "";
      if(dateInput)  dateInput.value  = bowlingDate  || "";
    }

    function clearSuggestions(){
      if(suggestList) suggestList.innerHTML = "";
    }

    function prepCoords(){
      loadBowlingBookmark();
      refreshEmbeddedMap();
      if(mapsHint) mapsHint.textContent = "";
      clearSuggestions();
      if(suggestHint) suggestHint.textContent = "";
    }

    btnOpenMap?.addEventListener("click", () => {
      refreshEmbeddedMap();
      openMapSearch();
    });

    cityInput?.addEventListener("change", refreshEmbeddedMap);
    cityInput?.addEventListener("keyup", (e) => {
      if(e.key === "Enter"){
        refreshEmbeddedMap();
        openMapSearch();
      }
    });

    venueInput?.addEventListener("keyup", (e) => {
      if(e.key === "Enter") btnVerifyMaps?.click();
    });

    btnUseLocation?.addEventListener("click", () => {
      if(!navigator.geolocation){
        if(mapsHint) mapsHint.textContent = "Location not supported üò≠ Just type the place name instead.";
        return;
      }
      if(mapsHint) mapsHint.textContent = "Getting location‚Ä¶";
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords?.latitude;
          const lng = pos.coords?.longitude;
          if(typeof lat !== "number" || typeof lng !== "number"){
            if(mapsHint) mapsHint.textContent = "Couldn‚Äôt read location. Type the place name instead.";
            return;
          }

          rememberUserLocation(lat, lng);

          bowlingVenue = (venueInput?.value || "").trim() || "Bowling near me";
          bowlingDate  = (dateInput?.value  || "").trim() || bowlingDate || "";
          bowlingLink  = `https://www.google.com/maps/search/bowling+alley/@${lat},${lng},14z`;

          saveBowlingBookmark();
          refreshEmbeddedMap();

          if(mapsHint) mapsHint.textContent = "Saved ‚úÖ (auto link created). You can just continue.";
          burstHearts(8);
        },
        () => {
          if(mapsHint) mapsHint.textContent = "Location blocked. No problem ‚Äî type the place name and save.";
        },
        { enableHighAccuracy:false, timeout:8000, maximumAge:60000 }
      );
    });

    btnVerifyMaps?.addEventListener("click", () => {
      const typedVenue = (venueInput?.value || "").trim();
      const typedDate  = (dateInput?.value  || "").trim();
      const typedCity  = (cityInput?.value  || "").trim();
      const alreadyHasAutoLink = !!(bowlingLink && bowlingLink.length);

      if(!typedVenue && !typedCity && !alreadyHasAutoLink){
        if(mapsHint) mapsHint.textContent = "Just type the place name (or open Map and type a city).";
        return;
      }

      if(typedVenue){
        bowlingVenue = typedVenue;
      }else if(typedCity){
        bowlingVenue = `Bowling alley in ${typedCity}`;
      }else{
        bowlingVenue = bowlingVenue || "Bowling near me";
      }

      bowlingDate = typedDate || bowlingDate || "";

      if(!alreadyHasAutoLink){
        bowlingLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(bowlingVenue)}`;
      }

      saveBowlingBookmark();
      if(mapsHint) mapsHint.textContent = "Saved ‚úÖ (no copying required).";

      setTimeout(() => {
        showWipe();
        hide(screenCoords);
        show(screenVault);
        if(mapsHint) mapsHint.textContent = "";
      }, 650);
    });

    btnSkipMaps?.addEventListener("click", () => {
      if(mapsHint) mapsHint.textContent = "Okay üò≠ We'll pick a bowling place soon. Continuing‚Ä¶";
      setTimeout(() => {
        showWipe();
        hide(screenCoords);
        show(screenVault);
        if(mapsHint) mapsHint.textContent = "";
      }, 650);
    });

    function niceName(displayName){
      const parts = (displayName || "").split(",").map(s => s.trim()).filter(Boolean);
      const title = parts.slice(0, 2).join(", ");
      const subtitle = parts.slice(2, 6).join(", ");
      return { title, subtitle };
    }

    async function fetchSuggestions(){
      clearSuggestions();
      if(suggestHint) suggestHint.textContent = "Finding options‚Ä¶";

      const city = (cityInput?.value || "").trim();
      const typed = (venueInput?.value || "").trim();

      let q = "";
      if(typed){
        q = typed;
      } else if(city){
        q = `bowling alley ${city}`;
      } else if(userLat != null && userLng != null){
        q = "bowling alley";
      } else {
        if(suggestHint) suggestHint.textContent = "Type a city in Map (optional) OR tap ‚ÄúUse my location‚Äù first.";
        return;
      }

      const base = "https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=7";
      let url = `${base}&q=${encodeURIComponent(q)}`;

      if(userLat != null && userLng != null){
        const d = 0.20;
        const left = (userLng - d).toFixed(6);
        const right = (userLng + d).toFixed(6);
        const top = (userLat + d).toFixed(6);
        const bottom = (userLat - d).toFixed(6);
        url += `&viewbox=${left},${top},${right},${bottom}&bounded=1`;
      }

      let results = [];
      try{
        const res = await fetch(url, { headers: { "Accept": "application/json" }});
        results = await res.json();
      }catch(e){
        if(suggestHint) suggestHint.textContent = "Couldn‚Äôt fetch options. No stress ‚Äî just type the place name.";
        return;
      }

      if(!Array.isArray(results) || results.length === 0){
        if(suggestHint) suggestHint.textContent = "No results found. Try typing a more specific name.";
        return;
      }

      if(suggestHint) suggestHint.textContent = "Tap one to auto-fill üëá";

      results.forEach(r => {
        const dn = r.display_name || "";
        const { title, subtitle } = niceName(dn);

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "suggestItem";
        btn.innerHTML = `${escapeHtml(title)}<span>${escapeHtml(subtitle)}</span>`;

        btn.addEventListener("click", () => {
          venueInput.value = title;

          if(mapFrame){
            mapFrame.src = `https://www.google.com/maps?q=${encodeURIComponent(title)}&output=embed`;
          }

          bowlingVenue = title;
          bowlingDate  = (dateInput?.value || "").trim() || bowlingDate || "";
          bowlingLink  = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(title)}`;

          if(mapsHint) mapsHint.textContent = "Selected ‚úÖ Now press Save & Continue.";
          burstHearts(6);
          clearSuggestions();
          if(suggestHint) suggestHint.textContent = "";
        });

        suggestList.appendChild(btn);
      });
    }

    btnSuggest?.addEventListener("click", fetchSuggestions);

    // ====== Vault ‚Üí Mode ‚Üí Ticket ======
    const vaultHint = document.getElementById("vaultHint");
    const modeHint  = document.getElementById("modeHint");
    const ticketBox = document.getElementById("ticketBox");
    const ticketHint = document.getElementById("ticketHint");
    const btnCopyTicket = document.getElementById("btnCopyTicket");
    const btnDownloadTicket = document.getElementById("btnDownloadTicket");
    const btnFinish = document.getElementById("btnFinish");

    const btnViewSummary = document.getElementById("btnViewSummary");
    const summaryBox = document.getElementById("summaryBox");
    const btnCopySummary = document.getElementById("btnCopySummary");
    const btnShareSummary = document.getElementById("btnShareSummary");
    const summaryHint = document.getElementById("summaryHint");

    document.querySelectorAll(".vaultBtn").forEach(b => {
      b.addEventListener("click", () => {
        chosenPath = b.getAttribute("data-path") || "";
        const label = getPathLabel(chosenPath) || "Unknown";
        if(vaultHint) vaultHint.textContent = `Option selected: ${label} ‚úÖ Generating claim ticket‚Ä¶`;
        setTimeout(() => {
          showWipe();
          hide(screenVault);
          show(screenMode);
          if(vaultHint) vaultHint.textContent = "";
        }, 600);
      });
    });

    document.querySelectorAll("#screenMode button[data-mode]").forEach(b => {
      b.addEventListener("click", () => {
        chosenMode = b.getAttribute("data-mode") || "Soft";
        if(modeHint) modeHint.textContent = `Mode locked: ${chosenMode} ‚úÖ`;
        setTimeout(() => {
          showWipe();
          hide(screenMode);
          show(screenTicket);
          buildTicket();
          if(modeHint) modeHint.textContent = "";
        }, 650);
      });
    });

    function buildTicket(){
      const id = Math.floor(1000 + Math.random() * 9000);
      ticketId = id;

      let storedLink = "";
      let storedVenue = "";
      let storedDate = "";
      try{
        storedLink  = (localStorage.getItem(LS_BOWLING_LINK)  || "");
        storedVenue = (localStorage.getItem(LS_BOWLING_VENUE) || "");
        storedDate  = (localStorage.getItem(LS_BOWLING_DATE)  || "");
      }catch(_){}

      const pathLabel = getPathLabel(chosenPath) || "Unknown";
      const dateNice = storedDate ? fmtDateISO(storedDate) : "TBD";
      const venueNice = storedVenue || "TBD";
      const linkNice = storedLink || (storedVenue ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(storedVenue)}` : "");

      ticketText =
`BIRTHDAY CLAIM TICKET #${id}
Subject: ${GIRL_NAME}
Operator: ${YOUR_NAME}
Option: ${pathLabel} | Mode: ${chosenMode}
Bowling: ${venueNice}
Date: ${dateNice}
Map: ${linkNice || "TBD"}
Rule: redeem after dinner üòå`;

      const safeLink = (linkNice || "").replaceAll('"', "%22").replaceAll("'", "%27");
      const mapBtnHtml = linkNice
        ? `<a class="miniBtn" href="${safeLink}" target="_blank" rel="noopener">Open Map</a>`
        : `<span class="miniBtn" style="opacity:.65;cursor:not-allowed;">Open Map</span>`;

      const compactHtml = `
        <div class="ticketCard">
          <div class="ticketTop">
            <div>
              <div class="ticketTitle">Birthday Claim Ticket</div>
              <div style="font-size:12px;opacity:.86;font-weight:900;margin-top:4px;color:rgba(83,75,62,.92);">
                paper edition ‚Ä¢ redeemable later ‚Ä¢ in-person only
              </div>
            </div>
            <div class="ticketId">#${id}</div>
          </div>

          <div style="margin-top:10px;">
            <span class="pill">${escapeHtml(pathLabel)}</span>
            <span class="pill">${escapeHtml(chosenMode)} mode</span>
            <span class="pill">after dinner</span>
          </div>

          <div class="ticketMeta">
            <div class="cell">
              <span class="k">Subject</span>
              <span class="v">${escapeHtml(GIRL_NAME)}</span>
            </div>
            <div class="cell">
              <span class="k">Operator</span>
              <span class="v">${escapeHtml(YOUR_NAME)}</span>
            </div>
            <div class="cell" style="grid-column: 1 / -1;">
              <span class="k">Bowling bookmark</span>
              <span class="v">${escapeHtml(venueNice)}</span>
            </div>
            <div class="cell">
              <span class="k">Date</span>
              <span class="v">${escapeHtml(dateNice)}</span>
            </div>
            <div class="cell">
              <span class="k">Snack override</span>
              <span class="v">${escapeHtml(snackSelected || "TBD")}</span>
            </div>
          </div>

          <div class="ticketCut">
            <div class="ticketNote">
              Screenshot this ticket ‚úÖ<br/>
              Redemption requires a smile + presence.
            </div>
            <div class="ticketActions">
              ${mapBtnHtml}
              <button class="miniBtn primaryMini" id="btnCopyTicketMini" type="button">Copy</button>
              <button class="miniBtn" id="btnDownloadTicketMini" type="button">Download PNG</button>
            </div>
          </div>
        </div>
      `;

      if(ticketBox) ticketBox.innerHTML = compactHtml;

      document.getElementById("btnCopyTicketMini")?.addEventListener("click", async () => {
        try{
          await navigator.clipboard.writeText(ticketText || "");
          if(ticketHint) ticketHint.textContent = "Copied ‚úÖ (still screenshot it though).";
        }catch(_){
          if(ticketHint) ticketHint.textContent = "Couldn‚Äôt auto-copy. Screenshot works perfectly.";
        }
      });

      document.getElementById("btnDownloadTicketMini")?.addEventListener("click", downloadTicketAsPng);

      if(ticketHint) ticketHint.textContent = "Paper ticket generated ‚úÖ Screenshot / copy / download PNG.";
    }

    // Ticket screen buttons
    btnDownloadTicket?.addEventListener("click", downloadTicketAsPng);

    btnCopyTicket?.addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(ticketText || "");
        if(ticketHint) ticketHint.textContent = "Copied ‚úÖ (still screenshot it though).";
      } catch (e) {
        if(ticketHint) ticketHint.textContent = "Couldn‚Äôt auto-copy here. Screenshot works perfectly.";
      }
    });

    btnFinish?.addEventListener("click", () => {
      protocolCompletedAt = new Date();
      buildSummary();

      showWipe();
      hide(screenTicket);
      show(screenSuccess);
      startConfetti(9000, 1400);

      setTimeout(() => {
        if (!screenSuccess.classList.contains("hidden")) {
          btnViewSummary?.click();
        }
      }, 2300);
    });

    // ====== Summary ======
    function fmt(ts){
      if(!ts) return "";
      try{
        return ts.toLocaleString(undefined, { year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit" });
      }catch(_){
        return String(ts);
      }
    }

    function buildSummary(){
      applyNames();

      try{
        bowlingLink  = localStorage.getItem(LS_BOWLING_LINK)  || bowlingLink || "";
        bowlingVenue = localStorage.getItem(LS_BOWLING_VENUE) || bowlingVenue || "";
        bowlingDate  = localStorage.getItem(LS_BOWLING_DATE)  || bowlingDate || "";
      }catch(_){}

      const started = protocolStartedAt ? fmt(protocolStartedAt) : "(unknown)";
      const completed = fmt(protocolCompletedAt || new Date());

      const pathLabel = getPathLabel(chosenPath) || "(not chosen)";
      const modeLabel = chosenMode || "(not chosen)";
      const snack = snackSelected || "(not selected)";
      const hearts = `${Math.max(heartsCollected, 5)} / 5`;

      const dateNice = bowlingDate ? fmtDateISO(bowlingDate) : "TBD";
      const venueLine = bowlingVenue ? bowlingVenue : "TBD";
      const linkLine  = bowlingLink ? bowlingLink : (bowlingVenue ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(bowlingVenue)}` : "TBD");

      summaryText =
`BIRTHDAY PROTOCOL ‚Äî SUMMARY
Subject: ${GIRL_NAME}
Operator: ${YOUR_NAME}

Started: ${started}
Completed: ${completed}

Hearts: ${hearts}
Snack: ${snack}

Bowling: ${venueLine}
Date: ${dateNice}
Map: ${linkLine}

Option: ${pathLabel}
Mode: ${modeLabel}
Ticket: #${ticketId ?? "‚Äî"}

Note: Bowling is queued for later ‚Äî dinner stays untouched.`;

      const safeLink = (linkLine || "").replaceAll('"', "%22").replaceAll("'", "%27");
      const linkHtml = (linkLine && linkLine !== "TBD")
        ? `<a class="miniBtn" href="${safeLink}" target="_blank" rel="noopener">Open Map</a>`
        : `<span class="miniBtn" style="opacity:.65;">No map saved</span>`;

      const html = `
        <div class="ticketCard">
          <div class="ticketTop">
            <div>
              <div class="ticketTitle">Mission Summary</div>
              <div style="font-size:12px;opacity:.86;font-weight:900;margin-top:4px;color:rgba(83,75,62,.92);">
                screenshot + send to ${escapeHtml(YOUR_NAME)}
              </div>
            </div>
            <div class="ticketId">#${ticketId ?? "‚Äî"}</div>
          </div>

          <div style="margin-top:10px;">
            <span class="pill">${escapeHtml(pathLabel)}</span>
            <span class="pill">${escapeHtml(modeLabel)} mode</span>
            <span class="pill">bowling queued</span>
          </div>

          <div class="ticketMeta" style="margin-top:10px;">
            <div class="cell">
              <span class="k">Subject</span>
              <span class="v">${escapeHtml(GIRL_NAME)}</span>
            </div>
            <div class="cell">
              <span class="k">Snack</span>
              <span class="v">${escapeHtml(snack)}</span>
            </div>
            <div class="cell" style="grid-column:1/-1;">
              <span class="k">Bowling</span>
              <span class="v">${escapeHtml(venueLine)}</span>
            </div>
            <div class="cell">
              <span class="k">Date</span>
              <span class="v">${escapeHtml(dateNice)}</span>
            </div>
            <div class="cell">
              <span class="k">Map</span>
              <span class="v">${linkHtml}</span>
            </div>
          </div>

          <div class="ticketCut">
            <div class="ticketNote">${escapeHtml(summaryText)}</div>
            <div class="ticketActions"></div>
          </div>
        </div>
      `;

      if(summaryBox) summaryBox.innerHTML = html;

      if(summaryHint){
        summaryHint.textContent = `Screenshot this page now üì∏ then send it to ${YOUR_NAME}.`;
      }
    }

    btnViewSummary?.addEventListener("click", () => {
      stopConfetti();
      protocolCompletedAt = protocolCompletedAt || new Date();
      buildSummary();

      showWipe();
      hide(screenSuccess);
      show(screenSummary);
    });

    btnCopySummary?.addEventListener("click", async () => {
      try{
        await navigator.clipboard.writeText(summaryText || "");
        if(summaryHint) summaryHint.textContent = "Summary copied ‚úÖ Screenshot still preferred.";
      }catch(_){
        if(summaryHint) summaryHint.textContent = "Couldn‚Äôt auto-copy. Screenshot works perfectly.";
      }
    });

    btnShareSummary?.addEventListener("click", async () => {
      const text = summaryText || "Birthday Protocol summary";
      try{
        if(navigator.share){
          await navigator.share({ text });
          if(summaryHint) summaryHint.textContent = "Shared ‚úÖ Now screenshot and send if you can.";
        } else {
          await navigator.clipboard.writeText(text);
          if(summaryHint) summaryHint.textContent = "Share not available ‚Äî copied text instead ‚úÖ";
        }
      }catch(_){
        if(summaryHint) summaryHint.textContent = "Okay üòå";
      }
    });

    // ====== Confetti ======
    const confettiCanvas = document.getElementById("confettiCanvas");
    const ctx = confettiCanvas.getContext("2d");
    let confettiRunning = false;
    let confettiParticles = [];
    let confettiRAF = null;

    function resizeConfetti(){
      confettiCanvas.width = window.innerWidth * devicePixelRatio;
      confettiCanvas.height = window.innerHeight * devicePixelRatio;
      confettiCanvas.style.width = window.innerWidth + "px";
      confettiCanvas.style.height = window.innerHeight + "px";
      ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);
    }
    window.addEventListener("resize", resizeConfetti);

    function drawHeart(x, y, s, rot, color, alpha){
      ctx.save();
      ctx.translate(x, y);
      ctx.rotate(rot);
      ctx.globalAlpha = alpha;
      ctx.fillStyle = color;

      ctx.beginPath();
      ctx.moveTo(0, -0.35*s);
      ctx.bezierCurveTo(0.5*s, -0.9*s, 1.25*s, -0.1*s, 0, 0.75*s);
      ctx.bezierCurveTo(-1.25*s, -0.1*s, -0.5*s, -0.9*s, 0, -0.35*s);
      ctx.closePath();
      ctx.fill();

      ctx.restore();
    }

    function spawnParticle(burst = false){
      const colors = ["#4efcff","#ff3b7a","#ffd24a","#e9f0ff","#a8b7e6"];
      const color = colors[Math.floor(Math.random() * colors.length)];
      const type = Math.random() < 0.22 ? "heart" : "rect";

      const fromCenter = burst ? Math.random() < 0.75 : Math.random() < 0.35;
      const x = fromCenter ? (window.innerWidth * 0.5 + randFloat(-70, 70)) : randFloat(0, window.innerWidth);
      const y = burst ? randFloat(-40, 10) : randFloat(-window.innerHeight * 0.25, -10);

      const base = type === "heart" ? randFloat(10, 16) : randFloat(6, 11);
      const w = base;
      const h = type === "rect" ? randFloat(10, 16) : base;

      const vx = burst ? randFloat(-2.4, 2.4) : randFloat(-1.6, 1.6);
      const vy = burst ? randFloat(2.2, 6.2) : randFloat(3.0, 6.2);

      return {
        type, x, y, w, h, vx, vy,
        swayAmp: randFloat(0.6, 1.6),
        swayFreq: randFloat(0.006, 0.014),
        swayPhase: randFloat(0, Math.PI * 2),
        rot: randFloat(0, Math.PI * 2),
        vr: randFloat(-0.14, 0.14),
        color,
        alpha: randFloat(0.85, 1),
        drag: randFloat(0.992, 0.998)
      };
    }

    function startConfetti(durationMs = 10000, fadeMs = 1600){
      resizeConfetti();
      confettiCanvas.classList.remove("hidden");
      confettiRunning = true;

      confettiParticles = [];
      const initialCount = 260;
      for (let i=0; i<initialCount; i++) confettiParticles.push(spawnParticle(true));

      const start = performance.now();
      const end = start + durationMs;

      const emitUntil = start + 1800;
      const emitRate = 14;

      function tick(t){
        if (!confettiRunning) return;

        const timeLeft = end - t;
        const fadeMul = clamp01(timeLeft / fadeMs);

        ctx.clearRect(0, 0, window.innerWidth, window.innerHeight);

        if (t < emitUntil){
          const intensity = 1 - ((t - start) / (emitUntil - start));
          const toEmit = Math.floor(emitRate * intensity);
          for (let i=0; i<toEmit; i++){
            if (confettiParticles.length < 520) confettiParticles.push(spawnParticle(true));
          }
        }

        const wind = (Math.sin(t * 0.0012) * 0.25) * (0.75 + 0.25 * fadeMul);
        const gravity = 0.045;

        for (const p of confettiParticles){
          const sway = Math.sin(t * p.swayFreq + p.swayPhase) * p.swayAmp;

          p.vx = (p.vx + wind * 0.02) * p.drag;
          p.vy = (p.vy + gravity) * p.drag;

          p.x += p.vx + sway * 0.06;
          p.y += p.vy;
          p.rot += p.vr;

          if (p.x < -40) p.x = window.innerWidth + 40;
          if (p.x > window.innerWidth + 40) p.x = -40;

          if (p.y > window.innerHeight + 60 && t < end - fadeMs){
            const np = spawnParticle(false);
            p.type = np.type; p.x = np.x; p.y = np.y;
            p.w = np.w; p.h = np.h;
            p.vx = np.vx; p.vy = np.vy;
            p.swayAmp = np.swayAmp; p.swayFreq = np.swayFreq; p.swayPhase = np.swayPhase;
            p.rot = np.rot; p.vr = np.vr;
            p.color = np.color; p.alpha = np.alpha; p.drag = np.drag;
          }

          const a = p.alpha * fadeMul;

          if (p.type === "heart"){
            drawHeart(p.x, p.y, p.w, p.rot, p.color, a);
          } else {
            ctx.save();
            ctx.globalAlpha = a;
            ctx.translate(p.x, p.y);
            ctx.rotate(p.rot);
            ctx.fillStyle = p.color;
            ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
            ctx.restore();
          }
        }

        if (t >= end){
          stopConfetti();
          return;
        }

        confettiRAF = requestAnimationFrame(tick);
      }

      confettiRAF = requestAnimationFrame(tick);
    }

    function stopConfetti(){
      confettiRunning = false;
      if (confettiRAF) cancelAnimationFrame(confettiRAF);
      confettiRAF = null;
      confettiCanvas.classList.add("hidden");
      ctx.clearRect(0, 0, window.innerWidth, window.innerHeight);
    }

    // ====== Start ======
    applyNames();
    runIntro();
  </script>
</body>
</html>